╔════════════════════════════════════════════════════════════════════════════════╗
║                   ПОТОК УНИКАЛИЗАЦИИ ФОТО - ВИЗУАЛИЗАЦИЯ                      ║
╚════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────────┐
│  ШАГ 1: Пользователь нажимает "🖼 Уникализировать фото"                       │
│  Handler: unique_photo_start()                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  ШАГ 2: Пользователь отправляет фото                                           │
│  Handler: receive_photo()                                                       │
│  Сохраняет: photo_file_id, photo_file_size                                      │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  ШАГ 3: Бот показывает выбор количества копий                                  │
│                                                                                 │
│  ╔═══════════════════════════════════════════════════════════════╗             │
│  ║  Выберите количество уникальных копий (от 1 до 10):          ║             │
│  ║  ┌───┬───┬───┬───┬───┐                                       ║             │
│  ║  │ 1 │ 2 │ 3 │ 4 │ 5 │                                       ║             │
│  ║  └───┴───┴───┴───┴───┘                                       ║             │
│  ║  ┌───┬───┬───┬───┬───┐                                       ║             │
│  ║  │ 6 │ 7 │ 8 │ 9 │ 10│                                       ║             │
│  ║  └───┴───┴───┴───┴───┘                                       ║             │
│  ║  ┌──────────────┐                                            ║             │
│  ║  │ ◀️ Назад     │                                            ║             │
│  ║  └──────────────┘                                            ║             │
│  ╚═══════════════════════════════════════════════════════════════╝             │
│                                                                                 │
│  Handler: select_copies_count()                                                 │
│  Сохраняет: copies_count                                                        │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  ШАГ 4: 📁 Выбор формата файла                                                 │
│                                                                                 │
│  ╔═══════════════════════════════════════════════════════════════╗             │
│  ║  📁 Выберите формат файла:                                    ║             │
│  ║  ┌───────┬───────┬───────┐                                    ║             │
│  ║  │ JPEG  │  PNG  │ WEBP  │                                    ║             │
│  ║  └───────┴───────┴───────┘                                    ║             │
│  ║  ┌─────────────────────┐                                      ║             │
│  ║  │ ◀️ Назад в меню     │                                      ║             │
│  ║  └─────────────────────┘                                      ║             │
│  ╚═══════════════════════════════════════════════════════════════╝             │
│                                                                                 │
│  Handler: select_file_format()                                                  │
│  Сохраняет: file_format (jpeg/png/webp)                                         │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  ШАГ 5: 🔄 Отражение по горизонтали                                            │
│                                                                                 │
│  ╔═══════════════════════════════════════════════════════════════╗             │
│  ║  🔄 Отразить по горизонтали?                                  ║             │
│  ║  ┌──────────┬──────────┐                                      ║             │
│  ║  │  ✅ Да  │  ❌ Нет  │                                      ║             │
│  ║  └──────────┴──────────┘                                      ║             │
│  ║  ┌─────────────────────┐                                      ║             │
│  ║  │ ◀️ Назад в меню     │                                      ║             │
│  ║  └─────────────────────┘                                      ║             │
│  ╚═══════════════════════════════════════════════════════════════╝             │
│                                                                                 │
│  Handler: select_flip_choice()                                                  │
│  Сохраняет: flip_horizontal (True/False)                                        │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  ШАГ 6: ✍️ Добавление текста                                                   │
│                                                                                 │
│  ╔═══════════════════════════════════════════════════════════════╗             │
│  ║  ✍️ Добавить текст?                                           ║             │
│  ║  ┌──────────┬──────────┐                                      ║             │
│  ║  │  ✅ Да  │  ❌ Нет  │                                      ║             │
│  ║  └──────────┴──────────┘                                      ║             │
│  ║  ┌─────────────────────┐                                      ║             │
│  ║  │ ◀️ Назад в меню     │                                      ║             │
│  ║  └─────────────────────┘                                      ║             │
│  ╚═══════════════════════════════════════════════════════════════╝             │
│                                                                                 │
│  Handler: select_text_choice()                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                   │                                │
          Если ДА │                                │ Если НЕТ
                   ▼                                ▼
    ┌──────────────────────────┐           ┌─────────────────┐
    │ ШАГ 6.1: Ввод текста     │           │ overlay_text =  │
    │                          │           │ None            │
    │ Пользователь вводит:     │           └─────────────────┘
    │ "© My Brand 2026"        │                    │
    │                          │                    │
    │ Handler:                 │                    │
    │ receive_text_input()     │                    │
    │ Сохраняет: overlay_text  │                    │
    └──────────────────────────┘                    │
                   │                                │
                   └────────────────┬───────────────┘
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  ШАГ 7: ➕ Добавление дополнительного фото                                     │
│                                                                                 │
│  ╔═══════════════════════════════════════════════════════════════╗             │
│  ║  ➕ Добавить дополнительное фото?                             ║             │
│  ║  ┌──────────┬──────────┐                                      ║             │
│  ║  │  ✅ Да  │  ❌ Нет  │                                      ║             │
│  ║  └──────────┴──────────┘                                      ║             │
│  ║  ┌─────────────────────┐                                      ║             │
│  ║  │ ◀️ Назад в меню     │                                      ║             │
│  ║  └─────────────────────┘                                      ║             │
│  ╚═══════════════════════════════════════════════════════════════╝             │
│                                                                                 │
│  Handler: select_overlay_choice()                                               │
└─────────────────────────────────────────────────────────────────────────────────┘
                   │                                │
          Если ДА │                                │ Если НЕТ
                   ▼                                ▼
    ┌──────────────────────────┐           ┌──────────────────────┐
    │ ШАГ 7.1: Отправка фото   │           │ ЗАПУСК ОБРАБОТКИ     │
    │                          │           │                      │
    │ Пользователь отправляет  │           │ process_photo_       │
    │ второе фото (логотип)    │           │ uniquification()     │
    │                          │           └──────────────────────┘
    │ Handler:                 │
    │ receive_overlay_photo()  │
    │ Сохраняет:               │
    │ overlay_photo_id         │
    └──────────────────────────┘
                   │
                   ▼
    ┌──────────────────────────────────────────────────────────────┐
    │ ШАГ 7.2: Выбор позиции                                       │
    │                                                              │
    │ ╔══════════════════════════════════════════════════════════╗ │
    │ ║ 📍 Выберите позицию дополнительного фото:               ║ │
    │ ║ ┌───────────────┬───────────────┐                       ║ │
    │ ║ │ ↖️ Верх-лево  │ ↗️ Верх-право │                       ║ │
    │ ║ └───────────────┴───────────────┘                       ║ │
    │ ║ ┌───────────────┬───────────────┐                       ║ │
    │ ║ │ ↙️ Низ-лево   │ ↘️ Низ-право  │                       ║ │
    │ ║ └───────────────┴───────────────┘                       ║ │
    │ ║ ┌───────────────┐                                       ║ │
    │ ║ │  🎯 Центр     │                                       ║ │
    │ ║ └───────────────┘                                       ║ │
    │ ║ ┌─────────────────────┐                                 ║ │
    │ ║ │ ◀️ Назад в меню     │                                 ║ │
    │ ║ └─────────────────────┘                                 ║ │
    │ ╚══════════════════════════════════════════════════════════╝ │
    │                                                              │
    │ Handler: select_overlay_position()                           │
    │ Сохраняет: overlay_position                                  │
    └──────────────────────────────────────────────────────────────┘
                   │
                   ▼
    ┌──────────────────────────────────────────────────────────────┐
    │ ШАГ 7.3: Ввод непрозрачности                                │
    │                                                              │
    │ ╔══════════════════════════════════════════════════════════╗ │
    │ ║ 🎨 Введите непрозрачность дополнительного фото (0-100): ║ │
    │ ║                                                          ║ │
    │ ║ 0 = полностью прозрачное                                ║ │
    │ ║ 100 = полностью непрозрачное                            ║ │
    │ ║                                                          ║ │
    │ ║ (Отправьте число от 0 до 100)                           ║ │
    │ ╚══════════════════════════════════════════════════════════╝ │
    │                                                              │
    │ Пользователь вводит: 40                                     │
    │                                                              │
    │ Handler: receive_overlay_opacity()                           │
    │ Сохраняет: overlay_opacity                                   │
    │ Валидация: 0 <= число <= 100                                │
    └──────────────────────────────────────────────────────────────┘
                   │
                   └────────────────┐
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  ШАГ 8: 🚀 ОБРАБОТКА И ОТПРАВКА                                               │
│                                                                                 │
│  Handler: process_photo_uniquification()                                        │
│                                                                                 │
│  1. Скачивание основного фото                                                  │
│  2. Скачивание overlay фото (если есть)                                        │
│  3. Создание action_log в БД                                                   │
│  4. Запуск Celery задачи uniquify_photo_task() с параметрами:                  │
│     - copies_count                                                              │
│     - file_format                                                               │
│     - flip_horizontal                                                           │
│     - overlay_text                                                              │
│     - overlay_photo_path                                                        │
│     - overlay_position                                                          │
│     - overlay_opacity                                                           │
│                                                                                 │
│  5. Celery worker обрабатывает (PhotoUniquifier):                              │
│     - Загрузка изображения                                                     │
│     - Применение отражения (если выбрано)                                      │
│     - Применение методов уникализации (шум, яркость, контраст и т.д.)         │
│     - Наложение текста (если есть)                                             │
│     - Наложение фото (если есть)                                               │
│     - Сохранение в выбранном формате                                           │
│     - Повтор N раз (по количеству копий)                                       │
│                                                                                 │
│  6. Отправка результатов пользователю                                          │
│                                                                                 │
│  ✅ ГОТОВО!                                                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

╔════════════════════════════════════════════════════════════════════════════════╗
║                          ПРИМЕР РЕЗУЛЬТАТА                                     ║
╚════════════════════════════════════════════════════════════════════════════════╝

Пользователь выбрал:
- Количество: 3 копии
- Формат: PNG
- Отражение: Да
- Текст: "© My Brand 2026"
- Доп. фото: Да
  - Позиция: Низ-право
  - Непрозрачность: 40

Результат: 3 PNG файла, каждый с:
✓ Зеркально отраженным изображением
✓ Уникальными изменениями (шум, яркость, контраст)
✓ Текстом "© My Brand 2026" внизу по центру
✓ Логотипом в правом нижнем углу с прозрачностью 40%

╔════════════════════════════════════════════════════════════════════════════════╗
║                     ФАЙЛЫ С КОДОМ РЕАЛИЗАЦИИ                                   ║
╚════════════════════════════════════════════════════════════════════════════════╝

📁 bot/keyboards/main_keyboards.py
   └─ get_file_format_keyboard()      (строки 114-124)
   └─ get_yes_no_keyboard()            (строки 127-136)
   └─ get_overlay_position_keyboard()  (строки 139-155)

📁 bot/handlers/uniquification.py
   └─ select_copies_count()            (строки 91-112)
   └─ select_file_format()             (строки 115-134)
   └─ select_flip_choice()             (строки 137-156)
   └─ select_text_choice()             (строки 159-183)
   └─ receive_text_input()             (строки 186-202)
   └─ select_overlay_choice()          (строки 205-224)
   └─ receive_overlay_photo()          (строки 227-243)
   └─ select_overlay_position()        (строки 246-267)
   └─ receive_overlay_opacity()        (строки 270-309)
   └─ process_photo_uniquification()   (строки 312-357)

📁 main.py
   └─ ConversationHandler регистрация  (строки 97-113)

📁 workers/tasks/uniquification_tasks.py
   └─ uniquify_photo_task()            (строки 16-93)

📁 workers/uniquification/photo_uniquifier.py
   └─ PhotoUniquifier.__init__()       (строки 17-30)
   └─ PhotoUniquifier.uniquify()       (строки 32-114)
   └─ _apply_text_overlay()            (строки 119-158)
   └─ _apply_photo_overlay()           (строки 160-219)
